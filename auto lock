#!/usr/bin/env python3
"""Standalone outer menu for auto-lock settings.

This app is intentionally outside Minecraft/Bedrock.
It stores state in JSON so another external runtime (injector/driver) can consume it.
"""

from __future__ import annotations

import json
from pathlib import Path
import tkinter as tk
from tkinter import ttk

ROOT = Path(__file__).resolve().parent.parent
CONFIG_PATH = ROOT / "config" / "autolock_settings.json"
DEFAULTS = {
    "enabled": False,
    "lock_closest_player": True,
    "range": 14,
    "fov": 110,
    "smoothness": 0.35,
    "hotkey": "F6",
}


class OuterMenuApp:
    def __init__(self) -> None:
        self.root = tk.Tk()
        self.root.title("Ultimate Cheats - Outer Menu")
        self.root.geometry("420x330")
        self.root.resizable(False, False)

        self.config = self.load_config()

        self.enabled_var = tk.BooleanVar(value=self.config["enabled"])
        self.closest_var = tk.BooleanVar(value=self.config["lock_closest_player"])
        self.range_var = tk.IntVar(value=self.config["range"])
        self.fov_var = tk.IntVar(value=self.config["fov"])
        self.smoothness_var = tk.DoubleVar(value=self.config["smoothness"])
        self.hotkey_var = tk.StringVar(value=self.config["hotkey"])

        self.status_var = tk.StringVar(value="Ready")
        self.build_ui()

    def load_config(self) -> dict:
        if CONFIG_PATH.exists():
            try:
                loaded = json.loads(CONFIG_PATH.read_text(encoding="utf-8"))
                return {**DEFAULTS, **loaded}
            except json.JSONDecodeError:
                pass
        return DEFAULTS.copy()

    def save_config(self) -> None:
        payload = {
            "enabled": self.enabled_var.get(),
            "lock_closest_player": self.closest_var.get(),
            "range": self.range_var.get(),
            "fov": self.fov_var.get(),
            "smoothness": round(self.smoothness_var.get(), 2),
            "hotkey": self.hotkey_var.get().strip() or "F6",
        }
        CONFIG_PATH.parent.mkdir(parents=True, exist_ok=True)
        CONFIG_PATH.write_text(json.dumps(payload, indent=2), encoding="utf-8")
        self.status_var.set(f"Saved to {CONFIG_PATH}")

    def build_ui(self) -> None:
        frm = ttk.Frame(self.root, padding=14)
        frm.pack(fill=tk.BOTH, expand=True)

        ttk.Label(frm, text="Auto Lock (External Menu)", font=("Segoe UI", 12, "bold")).pack(anchor="w")
        ttk.Label(frm, text="Runs outside the game/modpack.").pack(anchor="w", pady=(0, 10))

        ttk.Checkbutton(frm, text="Enable Auto Lock", variable=self.enabled_var).pack(anchor="w")
        ttk.Checkbutton(frm, text="Lock Closest Player", variable=self.closest_var).pack(anchor="w", pady=(0, 8))

        ttk.Label(frm, text="Range").pack(anchor="w")
        ttk.Scale(frm, from_=4, to=64, variable=self.range_var, orient="horizontal").pack(fill=tk.X)
        ttk.Label(frm, textvariable=self.range_var).pack(anchor="e")

        ttk.Label(frm, text="FOV").pack(anchor="w")
        ttk.Scale(frm, from_=20, to=180, variable=self.fov_var, orient="horizontal").pack(fill=tk.X)
        ttk.Label(frm, textvariable=self.fov_var).pack(anchor="e")

        ttk.Label(frm, text="Smoothness").pack(anchor="w")
        ttk.Scale(frm, from_=0.05, to=1.0, variable=self.smoothness_var, orient="horizontal").pack(fill=tk.X)

        hotkey_row = ttk.Frame(frm)
        hotkey_row.pack(fill=tk.X, pady=(10, 0))
        ttk.Label(hotkey_row, text="Toggle Hotkey").pack(side=tk.LEFT)
        ttk.Entry(hotkey_row, textvariable=self.hotkey_var, width=8).pack(side=tk.RIGHT)

        actions = ttk.Frame(frm)
        actions.pack(fill=tk.X, pady=(14, 6))
        ttk.Button(actions, text="Save", command=self.save_config).pack(side=tk.LEFT)
        ttk.Button(actions, text="Quit", command=self.root.destroy).pack(side=tk.RIGHT)

        ttk.Label(frm, textvariable=self.status_var, foreground="#3a7").pack(anchor="w", pady=(8, 0))

    def run(self) -> None:
        self.root.mainloop()


if __name__ == "__main__":
    OuterMenuApp().run()

